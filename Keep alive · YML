# GitHub Actions Workflow: Keep Hugging Face Space Alive
# This workflow pings the Hugging Face Space every 2 hours to prevent it from sleeping.
#
# Setup Instructions:
# 1. Create a new GitHub repository (or use an existing one)
# 2. Add this file to .github/workflows/keep_alive.yml
# 3. The workflow will run automatically every 2 hours
# 4. You can also trigger it manually from the Actions tab

name: Keep HF Space Alive

on:
  # Run every 2 hours
  schedule:
    - cron: '0 */2 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
  
  # Also run on push to main (for testing)
  push:
    branches:
      - main
    paths:
      - '.github/workflows/keep_alive.yml'
      - 'keep_alive.py'

jobs:
  ping-space:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Ping Hugging Face Space
        run: python keep_alive.py
        env:
          PYTHONUNBUFFERED: "1"
      
      - name: Log completion
        if: always()
        run: |
          echo "Ping completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  # Alternative: Simple curl-based ping (no Python needed)
  curl-ping:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Space with curl
        run: |
          echo "üöÄ Pinging Hugging Face Space..."
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "---"
          
          # Main space URL
          SPACE_URL="https://cata-risk-lab-veritas-scada-resilience.hf.space"
          
          # Attempt to ping with retries
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 60 \
              --retry 2 \
              --retry-delay 5 \
              "$SPACE_URL")
            
            echo "Response code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Space is alive!"
              exit 0
            elif [ "$HTTP_CODE" = "503" ]; then
              echo "üò¥ Space is sleeping, waiting 30s for it to wake up..."
              sleep 30
            else
              echo "‚ö†Ô∏è Got HTTP $HTTP_CODE, retrying..."
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è Space may need attention"
          # Don't fail the workflow, just warn
          exit 0
